name: Testing mitmproxy on Windows

on:
  workflow_dispatch:

jobs:
  test-with-mitmproxy-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      # Start mitmproxy logging
      - name: Start mitmproxy
        id: mitmproxy
        uses: yaegashi/mitmproxy-logger-action@v0.0.15
        with:
          enabled: true
          listen-host: '127.0.0.1'
          listen-port: '8080'
          passphrase: ${{ secrets.MITMPROXY_PASSPHRASE }}

      - name: Run Windows PowerShell (.NET HttpWebRequest)
        shell: powershell
        run: |
          $proxy = '${{ steps.mitmproxy.outputs.proxy-url }}'
          [System.Net.WebRequest]::DefaultWebProxy = New-Object System.Net.WebProxy($proxy, $true)
          Invoke-WebRequest -Uri "http://httpbin.org/get" -UseBasicParsing
          Invoke-WebRequest -Uri "https://httpbin.org/get" -UseBasicParsing
        continue-on-error: true

      - name: Run PowerShell Core (.NET HttpClient)
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "http://httpbin.org/get"
          Invoke-WebRequest -Uri "https://httpbin.org/get"
        continue-on-error: true
        env:
          http_proxy: ${{ steps.mitmproxy.outputs.proxy-url }}
          https_proxy: ${{ steps.mitmproxy.outputs.proxy-url }}

      - name: Run curl command (libcurl)
        shell: cmd
        run: |
          curl -v http://httpbin.org/get
          curl -v https://httpbin.org/get
        continue-on-error: true
        env:
          http_proxy: ${{ steps.mitmproxy.outputs.proxy-url }}
          https_proxy: ${{ steps.mitmproxy.outputs.proxy-url }}

      - name: Run certutil command (WinHttp)
        shell: powershell
        run: |
          try {
            netsh winhttp set proxy ${{ steps.mitmproxy.outputs.proxy-url }}
            certutil -urlcache -split -f http://httpbin.org/get NUL
            certutil -urlcache -split -f https://httpbin.org/get NUL
          } finally {
            netsh winhttp reset proxy
          }
        continue-on-error: true
